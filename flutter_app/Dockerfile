FROM ghcr.io/cirruslabs/flutter:3.27.3 AS build

WORKDIR /app
COPY pubspec.yaml ./
RUN flutter config --enable-web
RUN flutter pub get
COPY . ./

ARG FLUTTER_API_URL=/api
ARG FLUTTER_BOT_USERNAME=
ARG FLUTTER_VK_APP_ID=
ARG FLUTTER_AUTH_MODE=telegram_web
ARG FLUTTER_STANDALONE_AUTH_URL=
ARG FLUTTER_STANDALONE_REDIRECT_URI=gigme://auth
ARG FLUTTER_ENABLE_PUSH=false
ARG FLUTTER_ADMIN_TELEGRAM_IDS=
ARG FLUTTER_PAYMENT_PHONE_NUMBER=
ARG FLUTTER_PAYMENT_USDT_WALLET=
ARG FLUTTER_PAYMENT_USDT_NETWORK=TRC20
ARG FLUTTER_PAYMENT_USDT_MEMO=
ARG FLUTTER_PAYMENT_QR_DATA=

RUN flutter build web --release \
  --pwa-strategy=none \
  --base-href / \
  --dart-define=API_URL=${FLUTTER_API_URL} \
  --dart-define=BOT_USERNAME=${FLUTTER_BOT_USERNAME} \
  --dart-define=VK_APP_ID=${FLUTTER_VK_APP_ID} \
  --dart-define=AUTH_MODE=${FLUTTER_AUTH_MODE} \
  --dart-define=STANDALONE_AUTH_URL=${FLUTTER_STANDALONE_AUTH_URL} \
  --dart-define=STANDALONE_REDIRECT_URI=${FLUTTER_STANDALONE_REDIRECT_URI} \
  --dart-define=ENABLE_PUSH=${FLUTTER_ENABLE_PUSH} \
  --dart-define=ADMIN_TELEGRAM_IDS=${FLUTTER_ADMIN_TELEGRAM_IDS} \
  --dart-define=PAYMENT_PHONE_NUMBER=${FLUTTER_PAYMENT_PHONE_NUMBER} \
  --dart-define=PAYMENT_USDT_WALLET=${FLUTTER_PAYMENT_USDT_WALLET} \
  --dart-define=PAYMENT_USDT_NETWORK=${FLUTTER_PAYMENT_USDT_NETWORK} \
  --dart-define=PAYMENT_USDT_MEMO=${FLUTTER_PAYMENT_USDT_MEMO} \
  --dart-define=PAYMENT_QR_DATA=${FLUTTER_PAYMENT_QR_DATA}

FROM nginx:1.27-alpine
COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=build /app/build/web /usr/share/nginx/html
EXPOSE 80
